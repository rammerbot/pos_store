{% extends 'layout.html' %}
{% load static %}

{% block title %}Crear Presupuesto{% endblock %}

{% block content %}
{% include "includes/side_bar.html" %}

<div id="content-wrapper" class="d-flex flex-column">
    <div id="content">
        {% include "includes/header.html" %}
        
        <div class="container-fluid">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h5><i class="fas fa-file-invoice-dollar"></i> Crear Presupuesto</h5>
                        <small class="text-muted">Los presupuestos no se guardan en el sistema, solo se generan para imprimir.</small>
                    </div>
                </div>
            </div>

            <form id="budgetForm" method="post" action="{% url 'sales:generate_budget_pdf' %}">
                {% csrf_token %}
                
                <!-- Información del Cliente -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Información del Cliente</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="customer_name">Nombre del Cliente *</label>
                                            <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="customer_dni">DNI/Cédula</label>
                                            <input type="text" class="form-control" id="customer_dni" name="customer_dni">
                                        </div>
                                        <div class="form-group">
                                            <label for="customer_phone">Teléfono</label>
                                            <input type="text" class="form-control" id="customer_phone" name="customer_phone">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="customer_email">Email</label>
                                            <input type="email" class="form-control" id="customer_email" name="customer_email">
                                        </div>
                                        <div class="form-group">
                                            <label for="customer_address">Dirección</label>
                                            <textarea class="form-control" id="customer_address" name="customer_address" rows="3"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="validity_days">Validez (días)</label>
                                            <input type="number" class="form-control" id="validity_days" name="validity_days" value="30" min="1">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="observation">Observaciones</label>
                                    <textarea class="form-control" id="observation" name="observation" rows="2" placeholder="Observaciones adicionales..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">Productos del Presupuesto</h6>
                                <button type="button" class="btn btn-success btn-sm" id="addProduct">
                                    <i class="fas fa-plus"></i> Agregar Producto
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="productsTable">
                                        <thead>
                                            <tr>
                                                <th width="40%">Producto</th>
                                                <th width="15%">Cantidad</th>
                                                <th width="15%">Precio Unit.</th>
                                                <th width="15%">Subtotal</th>
                                                <th width="15%">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productsTableBody">
                                            <!-- Los productos se agregarán aquí dinámicamente -->
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-right"><strong>Subtotal:</strong></td>
                                                <td>
                                                    <input type="text" class="form-control-plaintext text-right" id="subtotal" name="subtotal" value="0.00" readonly>
                                                </td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" class="text-right"><strong>Descuento:</strong></td>
                                                <td>
                                                    <input type="number" class="form-control text-right" id="discount" name="discount" value="0" min="0" step="0.01">
                                                </td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" class="text-right"><strong>IVA (19%):</strong></td>
                                                <td>
                                                    <input type="text" class="form-control-plaintext text-right" id="tax" name="tax" value="0.00" readonly>
                                                </td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" class="text-right"><strong>TOTAL:</strong></td>
                                                <td>
                                                    <input type="text" class="form-control-plaintext text-right font-weight-bold" id="total_amount" name="total_amount" value="0.00" readonly>
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-body text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-print"></i> Generar e Imprimir Presupuesto
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg ml-2" onclick="clearForm()">
                                    <i class="fas fa-broom"></i> Limpiar Formulario
                                </button>
                                <a href="{% url 'sales:sales_list' %}" class="btn btn-danger btn-lg ml-2">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campo oculto para contar items -->
                <input type="hidden" id="item_count" name="item_count" value="0">
            </form>
        </div>
    </div>
</div>

<!-- Modal para seleccionar producto -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Seleccionar Producto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="productSearch" placeholder="Buscar producto por nombre o código...">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="productSelectionTable" style="width:100%">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr class="product-row">
                                <td>{{ product.code }}</td>
                                <td>{{ product.name }}</td>
                                <td>${{ product.price }}</td>
                                <td>{{ product.stock }}</td>
                                <td>
                                    <button type="button" class="btn btn-info btn-sm select-product" 
                                            data-id="{{ product.id }}"
                                            data-name="{{ product.name }}"
                                            data-price="{{ product.price }}"
                                            data-stock="{{ product.stock }}"
                                            {% if product.stock <= 0 %}disabled{% endif %}>
                                        <i class="fas fa-plus"></i> Seleccionar
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block JavaScript %}
<script>
    let itemCounter = 0;
    let selectedProducts = new Set(); // Para evitar duplicados

    $(document).ready(function() {
        // Inicializar tabla de selección de productos
        $('#productSelectionTable').DataTable({
            "pageLength": 5,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
            }
        });

        // Buscar productos
        $('#productSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.product-row').each(function() {
                const productName = $(this).find('td:nth-child(2)').text().toLowerCase();
                const productCode = $(this).find('td:nth-child(1)').text().toLowerCase();
                if (productName.includes(searchTerm) || productCode.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Limpiar búsqueda
        $('#clearSearch').click(function() {
            $('#productSearch').val('');
            $('.product-row').show();
        });

        // Abrir modal para agregar producto
        $('#addProduct').click(function() {
            $('#productModal').modal('show');
            $('#productSearch').focus();
        });

        // Seleccionar producto del modal
        $(document).on('click', '.select-product', function() {
            const productId = $(this).data('id');
            const productName = $(this).data('name');
            const productPrice = $(this).data('price');
            const productStock = $(this).data('stock');

            // Verificar si el producto ya fue agregado
            if (selectedProducts.has(productId)) {
                alert('Este producto ya ha sido agregado al presupuesto.');
                return;
            }

            addProductRow(productId, productName, productPrice, productStock);
            $('#productModal').modal('hide');
        });

        // Calcular totales cuando cambian cantidades
        $(document).on('input', '.quantity', function() {
            calculateRowTotal($(this).closest('tr'));
            calculateTotals();
        });

        // Calcular totales cuando cambia el descuento
        $('#discount').on('input', function() {
            calculateTotals();
        });

        // Eliminar producto
        $(document).on('click', '.remove-product', function() {
            const row = $(this).closest('tr');
            const productId = row.data('product-id');
            selectedProducts.delete(productId);
            row.remove();
            calculateTotals();
            updateItemCount();
        });
    });

    function addProductRow(productId, productName, productPrice, productStock) {
        itemCounter++;
        selectedProducts.add(productId);
        
        const row = `
            <tr data-product-id="${productId}">
                <td>
                    <input type="hidden" name="items[${itemCounter}][product_id]" value="${productId}">
                    <input type="hidden" name="items[${itemCounter}][product_name]" value="${productName}">
                    <input type="hidden" name="items[${itemCounter}][unit_price]" value="${productPrice}">
                    ${productName}
                </td>
                <td>
                    <input type="number" class="form-control quantity" name="items[${itemCounter}][quantity]" value="1" min="1" max="${productStock}" required>
                </td>
                <td class="text-right">
                    $<span class="unit-price-display">${parseFloat(productPrice).toFixed(2)}</span>
                </td>
                <td class="text-right">
                    $<span class="row-subtotal">${parseFloat(productPrice).toFixed(2)}</span>
                    <input type="hidden" name="items[${itemCounter}][subtotal]" value="${productPrice}">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-product">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        $('#productsTableBody').append(row);
        calculateTotals();
        updateItemCount();
    }

    function calculateRowTotal(row) {
        const quantity = parseFloat(row.find('.quantity').val()) || 0;
        const unitPrice = parseFloat(row.find('.unit-price-display').text()) || 0;
        const subtotal = quantity * unitPrice;
        
        row.find('.row-subtotal').text(subtotal.toFixed(2));
        row.find('input[name*="[subtotal]"]').val(subtotal.toFixed(2));
    }

    function calculateTotals() {
        let subtotal = 0;
        
        $('#productsTableBody tr').each(function() {
            const rowSubtotal = parseFloat($(this).find('.row-subtotal').text()) || 0;
            subtotal += rowSubtotal;
        });
        
        const discount = parseFloat($('#discount').val()) || 0;
        const tax = (subtotal - discount) * 0.19; // 19% IVA
        const total = subtotal - discount + tax;
        
        $('#subtotal').val(subtotal.toFixed(2));
        $('#tax').val(tax.toFixed(2));
        $('#total_amount').val(total.toFixed(2));
    }

    function updateItemCount() {
        $('#item_count').val($('#productsTableBody tr').length);
    }

    function clearForm() {
        if (confirm('¿Está seguro de que desea limpiar todo el formulario?')) {
            $('#budgetForm')[0].reset();
            $('#productsTableBody').empty();
            $('#subtotal').val('0.00');
            $('#tax').val('0.00');
            $('#total_amount').val('0.00');
            itemCounter = 0;
            selectedProducts.clear();
            updateItemCount();
        }
    }

    // Validar formulario antes de enviar
    $('#budgetForm').submit(function(e) {
        const customerName = $('#customer_name').val().trim();
        const productCount = $('#productsTableBody tr').length;
        
        if (!customerName) {
            e.preventDefault();
            alert('Por favor ingrese el nombre del cliente.');
            $('#customer_name').focus();
            return false;
        }
        
        if (productCount === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un producto al presupuesto.');
            return false;
        }
        
        return true;
    });
</script>
{% endblock %}