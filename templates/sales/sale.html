{% extends 'layout.html'%}

{% load static %}
{% block title %}Facturacion{% endblock %}

{% block content %}

<!-- Incluir SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

{% include "includes/side_bar.html" %}
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            {% include "includes/header.html" %}
            <!-- Begin Page Content -->
            <div class="container-fluid">
                <form method="post" id="frmCompras">
                    {% csrf_token %}
                    <div class="col-xl-12 col-md-12 mb-12">
                        {% if header %}
                        <div class="card border-left-warning shadow h-100 py-2">
                        {% else %}
                        <div class="card border-left-success shadow h-100 py-2">
                        {% endif %}
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            {% if header %} Editar {% else %} Nueva {% endif %} Factura
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <div class="row">
                                            <!-- Inicio Izquierda -->
                                            <div class="col-6">
                                                <!-- Inicio Encabezado -->
                                                <div class="form-group row">
                                                    <label for="customer" class="col-sm-2 col-form-label">Cliente:</label>
                                                    <div class="col-sm-6">
                                                        <select class=" border select2-client" id="id_customer" name="customer" required>
                                                            <option value="">Seleccione un cliente</option>
                                                            {% for customer in customers %}
                                                            <option value="{{ customer.id }}" 
                                                                    {% if header and header.customer.id == customer.id %}selected{% endif %}>
                                                                    {{ customer.full_name }} - {{ customer.dni }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <a class="btn btn-success col-sm-3" href="{% url "sales:create_customer" %}" onclick="open_modal('{% url "sales:create_customer" %}'); return false;">
                                                        <i class="fas fa-plus"></i> Nuevo Cliente
                                                    </a>
                                                </div>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="form-group">
                                                            <label for="date">Fecha:</label>
                                                            {{ header.date}}
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="description">Descripci√≥n:</label>
                                                            {{ sale_form.observation}}
                                                        </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-group">
                                                                <label for="invoice_number">No. Factura:</label>
                                                                {{ header.invoice_number}}
                                                            </div>                                           
                                                            <div class="row">
                                                                <div class="col">
                                                                    <label for="subtotal">Sub Total:</label>
                                                                </div>
                                                                <div class="col">
                                                                    {{  sale_form.subtotal }}
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <label for="discount">Descuento:</label>
                                                                </div>
                                                                <div class="col">
                                                                    {{  sale_form.discount }}
                                                                </div>
                                                            </div>
                                                            <!-- Nuevo campo para mostrar IVA del encabezado -->
                                                            <div class="row">
                                                                <div class="col">
                                                                    <label for="tax">IVA:</label>
                                                                </div>
                                                                <div class="col">
                                                                    {{  sale_form.tax }}
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <label for="total_amount">Total:</label>
                                                                </div>
                                                                <div class="col">
                                                                    {{  sale_form.total_amount }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Fin Encabezado -->
                                                </div>
                                                <!-- Fin Izquierda -->
                                                <!-- Inicio Derecha -->
                                                <div class="col-6 border">
                                                    <div class="row">
                                                        <div class="col">
                                                            <table class="table table-striped table-hover dt-responsive table-sm nowrap tbl-productos" style="width:100%">
                                                                <thead>
                                                                    <th>Codigo</th>        
                                                                    <th class="all">Producto</th>
                                                                    <th class="all">Disponible</th>
                                                                    <th class="all">Acciones</th>
                                                                </thead>
                                                                <tbody>
                                                                    {% for item in products %}
                                                                    <tr>
                                                                    <td>{{ item.code }}</td>
                                                                    <td>{{ item.name|truncatechars:25}}</td>
                                                                    <td>{{ item.stock}}</td>
                                                                    <td>
                                                                        <button type="button"
                                                                            class="btn btn-info {% if item.stock <= 0 %}btn-danger{% endif %}"
                                                                            {% if item.stock <= 0 %} disabled {% endif %}
                                                                            data-id="{{ item.id }}"
                                                                            data-name="{{ item.name|escapejs }}"
                                                                            data-price="{{ item.price }}"
                                                                            data-code="{{ item.code|escapejs }}"
                                                                            data-stock="{{ item.stock }}"
                                                                            onclick="selectProductoFromButton(this)">
                                                                            <i class="far fa-plus-square"></i>
                                                                        </button>
                                                                    </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <div class="form-group row">
                                                        <label for="id_id_producto" class="col-sm-3 col-form-label">Producto</label>
                                                        <div class="col-sm-2">
                                                            <input type="text" readonly class="form-control-plaintext" name="id_id_producto" id="id_id_producto" value="" required>
                                                        </div>
                                                        <div class="col-sm-7">
                                                            <input type="text" readonly class="form-control-plaintext" id="id_descripcion_producto" value="" required>
                                                        </div>
                                                    </div>
                                                    <div class="form-group row">
                                                        <label for="id_cantidad_detalle" class="col-sm-2 col-form-label">Cant.:</label>
                                                        <div class="col-sm-2">
                                                            <input type="number" class="form-control" name="id_cantidad_detalle" id="id_cantidad_detalle" value="00" required>
                                                        </div>
                                                        <label for="id_precio_detalle" class="col-sm-2 col-form-label">Precio:</label>
                                                        <div class="col-sm-2">
                                                            <input type="number" readonly class="form-control-plaintext" name="id_precio_detalle" id="id_precio_detalle" value="00" required>
                                                        </div>
                                                        <label for="id_descuento_detalle" class="col-sm-2 col-form-label">Desc. %:</label>
                                                        <div class="col-sm-2">
                                                            <input type="text" class="form-control" name="id_descuento" id="id_descuento" value="00">
                                                            <input type="text" hidden class="form-control" name="id_descuento_detalle" id="id_descuento_detalle" value="00">
                                                            
                                                        </div>
                                                        <label for="id_impuesto_detalle" class="col-sm-2 col-form-label">IVA%:</label>
                                                        <div class="col-sm-2">
                                                            <input type="checkbox" class="form-control" name="id_impuesto_detalle" id="id_impuesto_detalle" >
                                                        </div>
                                                        <div class="col-sm-2">
                                                            <input type="number" readonly class="form-control-plaintext" name="id_impuesto" id="id_impuesto" > 
                                                        </div>
                                                    </div>
                                                    <div class="form-group row">
                                                        <label for="subtotal" class="col-sm-2 col-form-label">S. Total:</label>
                                                        <div class="col-sm-4">
                                                            <input type="text" readonly class="form-control-plaintext" name="id_sub_total_detalle" id="id_sub_total_detalle" value="00">
                                                        </div>
                                                        <label for="id_total_detalle" class="col-sm-2 col-form-label">Total:</label>
                                                        <div class="col-sm-3">
                                                            <input type="text" readonly class="form-control-plaintext col-sm-10" name="id_total_detalle" id="id_total_detalle" value="00">
                                                        </div>
                                                        <div class="col-sm-1">
                                                            <button type="button" class="btn btn-sm col-sm-2" onclick="clear_Detail();"><i class="fa fa-minus-circle" aria-hidden="true"></i></button>
                                                        </div>
                                                    </div>
                                                    <!-- Botones -->
                                                    <div class="dropdown-divider"></div>
                                                    <div class="row">
                                                        <div class="col">
                                                            <button type="submit" class="btn btn-success"><span class="fa fa-save"></span> Guardar</button>
                                                            <a class="btn btn-warning" href="{% if header %}{% url "sales:print_invoice" header.id %}{% else %}#{% endif %}" target="reportes"><i class="fas fa-print"></i>Imprimir</a>
                                                            <a href="{% url 'sales:sales_list' %}" class="btn btn-danger"><i class="far fa-hand-point-left"></i> Cancelar</a>
                                                        </div>
                                                    </div>
                                                    <!-- Fin Botones -->
                                                </div>
                                                <!-- Fin Derecha -->
                                            </div>
                                            <!-- Inicio Detalle -->
                                            <div class="row">
                                                <div class="col">
                                                    <table class="table table-striped table-hover dt-responsive nowrap" style="width:100%" id="details-table">
                                                        <thead>
                                                            <th>Producto</th>        
                                                            <th>Cantidad</th>
                                                            <th>Precio</th>
                                                            <th>Sub Total</th>
                                                            <th>Desc.</th>
                                                            <th>IVA</th>
                                                            <th>Total</th>
                                                            <th class="all">Acciones</th>
                                                        </thead>
                                                        <tbody>
                                                            {% for item in sale_items %}
                                                            <tr id="item-{{ item.id }}">
                                                                <td>{{ item.product.name }}</td>
                                                                <td>{{ item.quantity }}</td>
                                                                <td>${{ item.unit_price }}</td>
                                                                <td>${{ item.subtotal }}</td>
                                                                <td>${{ item.discount }}</td>
                                                                <td>${{ item.tax }}</td>
                                                                <td>${{ item.total_price }}</td>
                                                                <td>
                                                                    <!--  
                                                                    <button type="button" 
                                                                            class="btn btn-danger btn-circle btn-sm" 
                                                                            onclick="deleteItem({{ item.id }}, {{ header.id }})"
                                                                            title="Eliminar item">
                                                                        <i class="fas fa-trash-alt"></i>
                                                                    </button>
                                                                    -->
                                                                    <button type="button" 
                                                                        class="btn btn-warning btn-circle btn-sm" 
                                                                        onclick="anularItem({{ item.id }}, {{ header.id }})"
                                                                        title="Anular item"
                                                                        {% if not item.status %}disabled{% endif %}>
                                                                    <i class="fas fa-ban"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>    
                                        </div>
                                    </div>
                                    <!-- Fin Detalle -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% block modal %}
        <div class="modal fade" id="popup" >
        </div>
    {% endblock modal %}
{% endblock %}
{% block JavaScript %}

<!-- Incluir SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
    function open_modal(url) 
    {
        $('#popup').load(url, function(){
        $(this).modal({
            backdrop: 'static',
            keyboard: false
        })
        $(this).modal('show');
       });
       return false;
    }
    function close_modal(){
        $('#popup').modal('hide');
        return false;
    }
</script>

<script>

    function open_modal(url) 
    {
        $('#popup').load(url, function(){
        $(this).modal({
            backdrop: 'static',
            keyboard: false
        })
        $(this).modal('show');
       });
       return false;
    }
    function close_modal(){
        $('#popup').modal('hide');
        return false;
    }
</script>

<script>
    // Inicializar Select2 para el campo de cliente
    $(document).ready(function() {
        $('.select2-client').select2({
            
            language: 'es',
            placeholder: 'Seleccione un cliente',
            allowClear: true,
            width: '100%',
            dropdownParent: $('#frmCompras'),
            templateResult: formatClient,
            templateSelection: formatClientSelection
        });

        function formatClient(client) {
            if (!client.id) {
                return client.text;
            }
            
            var $client = $(
                '<div class="client-option">' +
                    '<strong>' + client.text + '</strong>' +
                '</div>'
            );
            return $client;
        }

        function formatClientSelection(client) {
            return client.text;
        }

        // Manejar el evento cuando se selecciona un cliente
        $('#id_customer').on('change', function() {
            console.log('Cliente seleccionado:', $(this).val());
        });

        // Si hay un cliente seleccionado (en modo edici√≥n), inicializar Select2 con ese valor
        {% if header and header.customer %}
            $('#id_customer').val('{{ header.customer.id }}').trigger('change');
        {% endif %}
    });

    // Funci√≥n para recargar los clientes despu√©s de crear uno nuevo
    function reloadClients() {
        $.ajax({
            url: '{% url "sales:get_customers_json" %}',
            type: 'GET',
            success: function(data) {
                var select = $('#id_customer');
                select.empty();
                select.append('<option value="">Seleccione un cliente</option>');
                
                $.each(data.customers, function(index, customer) {
                    select.append(
                        '<option value="' + customer.id + '">' + 
                        customer.full_name + ' - ' + customer.dni + 
                        '</option>'
                    );
                });
                
                // Re-inicializar Select2
                select.select2({
                    theme: 'bootstrap-5',
                    language: 'es',
                    placeholder: 'Seleccione un cliente',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#frmCompras')
                });
            }
        });
    }

    // Funci√≥n para manejar el √©xito al crear un cliente
    function onCustomerCreated(customerId, customerName, customerDni) {
        var select = $('#id_customer');
        
        // Agregar el nuevo cliente a las opciones
        var newOption = new Option(customerName + ' - ' + customerDni, customerId, true, true);
        select.append(newOption);
        
        // Actualizar Select2
        select.trigger('change');
        
        // Cerrar el modal
        close_modal();
        
        // Mostrar mensaje de √©xito
        Swal.fire({
            title: '¬°√âxito!',
            text: 'Cliente creado correctamente',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
    }



    function updateTotals(totals) {
        console.log('Actualizando totales del encabezado:', totals);
        
        const subtotalField = document.querySelector('[name="subtotal"]');
        const discountField = document.querySelector('[name="discount"]');
        const taxField = document.querySelector('[name="tax"]');
        const totalAmountField = document.querySelector('[name="total_amount"]');
        
        if (totals.subtotal !== undefined && subtotalField) {
            subtotalField.value = totals.subtotal;
        }
        
        if (totals.discount !== undefined && discountField) {
            discountField.value = totals.discount;
        }
        
        if (totals.tax !== undefined && taxField) {
            taxField.value = totals.tax;
        }
        
        if (totals.total_amount !== undefined && totalAmountField) {
            totalAmountField.value = totals.total_amount;
        }
    }

    async function deleteItem(itemId, saleId) {
        const result = await Swal.fire({
            title: '¬øEst√°s seguro?',
            text: "¬°Esta acci√≥n no se puede deshacer!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'S√≠, eliminar',
            cancelButtonText: 'Cancelar',
            customClass: {
                popup: 'custom-swal-popup'
            }
        });

        if (!result.isConfirmed) {
            return;
        }

        const deleteBtn = event.target.closest('button');
        const originalHtml = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        deleteBtn.disabled = true;

        try {
            const response = await fetch(`/sales/sales/delete/${saleId}/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            });

            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }

            const data = await response.json();

            if (data.success) {
                // Eliminar la fila de la tabla con animaci√≥n
                const row = document.getElementById(`item-${itemId}`);
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 300);
                }
                
                // Actualizar los totales en el formulario
                if (data.updated_totals) {
                    updateTotals(data.updated_totals);
                }
                
                // Mostrar mensaje de √©xito
                await Swal.fire({
                    title: '¬°Eliminado!',
                    text: 'Item eliminado correctamente',
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.error || 'Error desconocido del servidor');
            }
        } catch (error) {
            console.error('Error:', error);
            await Swal.fire({
                title: 'Error',
                text: 'Error al eliminar el item: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#d33'
            });
        } finally {
            // Restaurar el bot√≥n
            deleteBtn.innerHTML = originalHtml;
            deleteBtn.disabled = false;
        }
    }

    // Funci√≥n para enviar el formulario por AJAX
    // Funci√≥n para enviar el formulario por AJAX
    function submitFormAJAX() {
        const formData = new FormData(document.getElementById('frmCompras'));
        
        // Mostrar indicador de carga
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalHtml = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        submitBtn.disabled = true;

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Si se cre√≥ una nueva factura, redirigir a la URL de edici√≥n
                if (data.redirect_url) {
                    // Mostrar mensaje de √©xito y redirigir
                    Swal.fire({
                        title: '¬°√âxito!',
                        text: data.message || 'Factura creada exitosamente',
                        icon: 'success',
                        confirmButtonColor: '#3085d6',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        // Redirigir a la edici√≥n de la nueva factura
                        window.location.href = data.redirect_url;
                    });
                } else {
                    // Actualizar los totales en el formulario (para ediciones)
                    if (data.updated_totals) {
                        updateTotals(data.updated_totals);
                    }
                    
                    // Mostrar mensaje de √©xito
                    Swal.fire({
                        title: '¬°√âxito!',
                        text: data.message || 'Producto guardado correctamente',
                        icon: 'success',
                        confirmButtonColor: '#3085d6',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // Recargar la p√°gina para mostrar los nuevos items
                        window.location.reload();
                    });
                }
            } else {
                throw new Error(data.error || 'Error desconocido del servidor');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al guardar: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#d33'
            });
        })
        .finally(() => {
            // Restaurar el bot√≥n
            submitBtn.innerHTML = originalHtml;
            submitBtn.disabled = false;
        });
    }

    
    // funcion para anunlar item
    async function anularItem(itemId, saleId) {
        const result = await Swal.fire({
            title: 'Anular Item',
            html: `
                <p>¬øEst√°s seguro de que deseas anular este item?</p>
                <p><strong>Esta acci√≥n devolver√° el producto al inventario y ajustar√° el total de la factura.</strong></p>
                <input type="password" id="adminPassword" class="swal2-input" placeholder="Contrase√±a de administrador" required>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f39c12',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Anular',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const password = document.getElementById('adminPassword').value;
                if (!password) {
                    Swal.showValidationMessage('La contrase√±a es requerida');
                }
                return { password: password };
            },
            customClass: {
                popup: 'custom-swal-popup'
            }
        });

        if (!result.isConfirmed) {
            return;
        }

        const anularBtn = event.target.closest('button');
        const originalHtml = anularBtn.innerHTML;
        anularBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        anularBtn.disabled = true;

        try {
            const response = await fetch(`/sales/sales/anular/${saleId}/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    admin_password: result.value.password
                })
            });

            const data = await response.json();

            if (data.success) {
                // Actualizar la fila para mostrar que est√° anulada
                const row = document.getElementById(`item-${itemId}`);
                if (row) {
                    row.style.backgroundColor = '#f8d7da'; // Color rojo claro para items anulados
                    row.style.opacity = '0.6';
                    
                    // Deshabilitar botones en la fila
                    const buttons = row.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    });
                    
                    // Agregar badge de "Anulado"
                    const statusCell = row.cells[7]; // √öltima celda
                    statusCell.innerHTML += '<span class="badge badge-danger ml-1">Anulado</span>';
                }
                
                // Actualizar los totales en el formulario
                if (data.updated_totals) {
                    updateTotals(data.updated_totals);
                }
                
                // Mostrar mensaje de √©xito
                await Swal.fire({
                    title: '¬°Anulado!',
                    text: 'Item anulado correctamente',
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.error || 'Error desconocido del servidor');
            }
        } catch (error) {
            console.error('Error:', error);
            await Swal.fire({
                title: 'Error',
                text: 'Error al anular el item: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#d33'
            });
        } finally {
            // Restaurar el bot√≥n
            anularBtn.innerHTML = originalHtml;
            anularBtn.disabled = false;
        }
    }

    // Estilos personalizados para SweetAlert2
    const style = document.createElement('style');
    style.textContent = `
        .custom-swal-popup {
            font-family: inherit;
            border-radius: 0.5rem;
        }
        .swal2-confirm {
            border-radius: 0.25rem !important;
        }
    `;
    document.head.appendChild(style);
</script>

<script>
    $(function () {
        $("#date").datetimepicker({
            format: 'Y-m-d',
            timepicker:false
        });

        $("#sidebarToggle").click();

        $('.table').DataTable({
            "pageLength": 5,
            "language": {
            "sProcessing": "Procesando...",
            "sLengthMenu": "Mostrar _MENU_ registros",
            "sZeroRecords": "No se encontraron resultados",
            "sEmptyTable": "Ning√∫n dato disponible en esta tabla",
            "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
            "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
            "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
            "sInfoPostFix": "",
            "sSearch": "Buscar:",
            "sUrl": "",
            "sInfoThousands": ",",
            "sLoadingRecords": "Cargando...",
            "oPaginate": {
                "sFirst": "<span class='fa fa-angle-double-left'></span>",
                "sLast": "<span class='fa fa-angle-double-right'></span>",
                "sNext": "<span class='fa fa-angle-right'></span>",
                "sPrevious": "<span class='fa fa-angle-left'></span>"
            },
            "oAria": {
                "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                "sSortDescending": ": Activar para ordenar la columna de manera descendente"
            }
            }
        });

        $('#id_cantidad_detalle,#id_precio_detalle,#id_descuento, #id_impuesto_detalle').change(function(){
            calcular_detalle();
        });

        /*Validar y Enviar Formulario por AJAX */
        $("#frmCompras").submit(function(e){
            e.preventDefault();

            // Validaciones b√°sicas
            let hasErrors = false;
            const orderNumber = $("#id_order_number").val();
            const buyDate = $("#id_buy_date").val();
            const orderDate = $("#id_order_date").val();
            const totalDetalle = $('#id_total_detalle').val();
            const idProducto = $('#id_id_producto').val();

            if(!totalDetalle || totalDetalle == 0 || !idProducto || idProducto === ""){
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No ha agregado producto o est√° sin cantidades'
                });
                hasErrors = true;
            }

            if (!hasErrors) {
                submitFormAJAX();
            }
        });
        /*Fin Validar Env√≠o de Detalle */
    });

    function selectProductoFromButton(btn) {
        const id    = btn.dataset.id;
        const name  = btn.dataset.name || btn.getAttribute('data-name');
        const price = parseFloat(btn.dataset.price) || 0;
        const code  = btn.dataset.code;
        const stock = parseFloat(btn.dataset.stock) || 0;

        $("#id_cantidad_detalle").val(1); // Cambiar a 1 en lugar de 0
        $('#id_precio_detalle').val(parseFloat(price).toFixed(2));
        $('#id_descuento').val(0);
        $('#id_descuento_detalle').val(0);
        $('#id_impuesto').val(0);
        $('#id_impuesto_detalle').prop('checked', false);

        $('#id_sub_total_detalle').val(0);
        $('#id_total_detalle').val(0);

        $("#id_id_producto").val(id);
        $('#id_descripcion_producto').val(name);
        $('#id_cantidad_detalle').focus();
        $('#id_cantidad_detalle').select();

        // Calcular autom√°ticamente al seleccionar producto
        calcular_detalle();
        
        $('.table').DataTable().search('').draw();
    }

    function calcular_detalle() {
        let cant, prec, descPorcentaje, descMonto, stotal, total, impuesto;

        cant = parseFloat($("#id_cantidad_detalle").val()) || 0;
        cant = cant < 0 ? 0 : cant;

        prec = parseFloat($('#id_precio_detalle').val()) || 0;
        prec = prec < 0 ? 0 : prec;

        descPorcentaje = parseFloat($('#id_descuento').val()) || 0;
        descPorcentaje = descPorcentaje < 0 ? 0 : descPorcentaje;
        descPorcentaje = descPorcentaje > 100 ? 100 : descPorcentaje;

        stotal = cant * prec;

        // üî∏ Obtener stock disponible del producto actual
        const stock = parseFloat($('button[data-id="' + $("#id_id_producto").val() + '"]').data('stock')) || 0;

        // üî∏ Validaci√≥n: cantidad no puede superar stock
        if (cant > stock) {
            $("#id_cantidad_detalle").val(stock); // Corrige el valor
            Swal.fire({
                icon: 'error',
                title: 'Cantidad inv√°lida',
                text: `Solo hay ${stock} unidades disponibles en inventario.`,
                timer: 2000,
                showConfirmButton: false
            });
            cant = stock;
        }

        // Calcular IVA (19%)
        if ($("#id_impuesto_detalle").is(":checked")) {
            impuesto = stotal * 0.19;
        } else {
            impuesto = 0;
        }

        // Calcular descuento en monto (sobre subtotal + IVA)
        descMonto = (stotal + impuesto) * (descPorcentaje / 100);
        total = (stotal + impuesto) - descMonto;

        // Actualizar campos
        $('#id_cantidad_detalle').val(cant);
        $('#id_precio_detalle').val(prec.toFixed(2));
        $('#id_descuento_detalle').val(descMonto.toFixed(2));
        $('#id_sub_total_detalle').val(stotal.toFixed(2));
        $('#id_total_detalle').val(total.toFixed(2));
        $('#id_impuesto').val(impuesto.toFixed(2));
    }


    function clear_Detail(){
        $('#id_cantidad_detalle').val(0);
        $('#id_precio_detalle').val(0);
        $('#id_descuento').val(0);
        $('#id_descuento_detalle').val(0);
        $('#id_impuesto_detalle').prop('checked', false);

        $('#id_sub_total_detalle').val(0);
        $('#id_total_detalle').val(0);
        $('#id_impuesto').val(0);

        $('#id_id_producto').val('');
        $('#id_descripcion_producto').val('');

        $('.table').DataTable().search('').draw();
        // Cambiar el focus a un campo que exista
        $("#id_cantidad_detalle").focus();
    }

    $("#id_proveedor").focus();
</script>

<script>
    {% if messages %}  
        {% for message in messages %}
            Swal.fire({
                icon: 'success',
                title: '√âxito',
                text: '{{ message }}',
                timer: 3000,
                showConfirmButton: false
            });
        {% endfor %}
    {% endif %}
</script>
{% endblock %}